<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デジタル神経衰弱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Google Fontsからポップなフォントを読み込む */
        @import url('https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Zen+Maru+Gothic:wght@400;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard */
        }

        h1, .font-pop {
            font-family: 'Mochiy Pop One', sans-serif;
        }

        /* カードのフリップ（裏返し）アニメーション */
        .card {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden; /* Safari */
        }

        .card-face.card-back {
            transform: rotateY(180deg);
        }

        /* 隠しinput要素をスタイリングしてクリックしやすくする */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<!-- ★★★ 修正点: flexboxによる中央揃えと高さ固定を解除し、自然なスクロールを許可 ★★★ -->
<body class="bg-yellow-50 text-gray-800">

    <!-- ========== タイトル画面 ========== -->
    <!-- ★★★ 修正点: 上下のpaddingを調整し、画面サイズに応じた左右のpaddingを設定 ★★★ -->
    <div id="title-screen" class="w-full max-w-2xl mx-auto py-8 px-4 sm:px-8 text-center">
        <h1 class="text-4xl md:text-6xl text-orange-500 mb-8 drop-shadow-md">デジタル神経衰弱</h1>

        <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-orange-200">
            <h2 class="text-xl font-bold mb-4 text-orange-600">1. 画像を選ぶ</h2>
            <p class="text-sm text-gray-500 mb-4">使う画像を選択してください。<br>同じ画像が2枚で1ペアになります。</p>
            <div class="grid md:grid-cols-2 gap-4">
                <label for="folder-input" class="w-full bg-teal-400 hover:bg-teal-500 text-white font-bold p-2 rounded-xl shadow-md cursor-pointer transition-transform transform hover:scale-105 h-20 flex flex-col justify-center items-center">
                    <span>フォルダを選択 (まとめて)</span>
                </label>
                <input type="file" id="folder-input" webkitdirectory directory multiple>

                <label for="files-input" class="w-full bg-sky-400 hover:bg-sky-500 text-white font-bold p-2 rounded-xl shadow-md cursor-pointer transition-transform transform hover:scale-105 h-20 flex flex-col justify-center items-center">
                    <span>画像を1枚ずつ選択</span>
                </label>
                <input type="file" id="files-input" multiple accept="image/*">
            </div>

             <div id="image-preview-area" class="flex flex-wrap justify-center gap-2 mt-6 hidden"></div>
             <p id="image-info" class="text-gray-600 hidden mt-4"></p>
        </div>
        
        <div id="difficulty-selection" class="mt-8 bg-white p-6 rounded-2xl shadow-lg border-2 border-orange-200">
            <h2 class="text-xl font-bold mb-4 text-orange-600">2. 難易度を選ぶ</h2>
            <p class="text-sm text-gray-500 mb-4">
                かんたん: 最初から全部見える<br>
                むずかしい: 全部うら面から
            </p>
            <div class="flex justify-center gap-4">
                <button id="easy-mode-btn" data-difficulty="easy" class="difficulty-btn w-1/2 bg-lime-500 hover:bg-lime-600 text-white font-bold p-2 rounded-xl shadow-md transition-transform transform hover:scale-105 h-20 flex flex-col justify-center items-center">
                    かんたん
                </button>
                <button id="hard-mode-btn" data-difficulty="hard" class="difficulty-btn w-1/2 bg-red-500 hover:bg-red-600 text-white font-bold p-2 rounded-xl shadow-md transition-transform transform hover:scale-105 h-20 flex flex-col justify-center items-center">
                    むずかしい
                </button>
            </div>
        </div>
    </div>

    <!-- ========== ゲーム画面 ========== -->
    <div id="game-screen" class="hidden w-full h-full flex flex-col p-4">
        <div class="flex justify-between items-start mb-2">
            <!-- タイトルへ戻るボタン -->
            <button id="back-to-title-btn" class="bg-orange-400 hover:bg-orange-500 text-white font-bold py-2 px-4 rounded-full shadow-md transition-transform transform hover:scale-105">
                タイトルに戻る
            </button>
            <!-- カードサイズ調整ボタン -->
            <div class="flex gap-2">
                <button id="zoom-out-btn" class="w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-100 text-gray-600 font-bold rounded-full shadow-md transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" /></svg>
                </button>
                <button id="zoom-in-btn" class="w-12 h-12 flex items-center justify-center bg-white hover:bg-gray-100 text-gray-600 font-bold rounded-full shadow-md transition-transform transform hover:scale-105">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                </button>
            </div>
        </div>

        <!-- ゲームボード -->
        <div id="game-board-container" class="flex-grow flex items-center justify-center overflow-auto">
             <div id="game-board" class="grid gap-2 md:gap-4 p-4">
                <!-- カードはここに動的に生成されます -->
            </div>
        </div>
    </div>
    
    <!-- ========== 音量調整 ========== -->
    <div class="absolute bottom-4 left-4">
        <button id="volume-settings-btn" class="w-14 h-14 flex items-center justify-center bg-pink-400 hover:bg-pink-500 text-white font-bold rounded-full shadow-lg transition-transform transform hover:scale-105">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
        </button>
        <div id="volume-controls" class="hidden absolute bottom-20 left-0 bg-white p-4 rounded-2xl shadow-2xl border-2 border-pink-200 w-64">
            <div class="mb-4">
                <label for="bgm-volume" class="block text-sm font-bold text-gray-700">BGM</label>
                <input type="range" id="bgm-volume" min="0" max="1" step="0.01" class="w-full h-2 bg-pink-100 rounded-lg appearance-none cursor-pointer">
            </div>
            <div>
                <label for="sfx-volume" class="block text-sm font-bold text-gray-700">効果音</label>
                <input type="range" id="sfx-volume" min="0" max="1" step="0.01" class="w-full h-2 bg-pink-100 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </div>
    
    <!-- ========== ゲームクリアモーダル ========== -->
    <div id="clear-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-10 rounded-3xl shadow-xl text-center transform scale-75 opacity-0 transition-all duration-300">
            <h2 class="font-pop text-5xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-6">CLEAR!</h2>
            <button id="back-to-title-from-clear-btn" class="bg-orange-400 hover:bg-orange-500 text-white font-bold py-3 px-8 rounded-full shadow-md transition-transform transform hover:scale-105">
                タイトルに戻る
            </button>
        </div>
    </div>


    <!-- ========== オーディオ要素 ========== -->
    <audio id="bgm-main" src="https://y-sensei-lab.github.io/memory-game/audio/bgm_main.mp3" loop></audio>
    <audio id="sfx-button" src="https://y-sensei-lab.github.io/memory-game/audio/sfx_button.mp3"></audio>
    <audio id="sfx-open" src="https://y-sensei-lab.github.io/memory-game/audio/sfx_open.mp3"></audio>
    <audio id="sfx-pair" src="https://y-sensei-lab.github.io/memory-game/audio/sfx_pair.mp3"></audio>
    <audio id="sfx-fail" src="https://y-sensei-lab.github.io/memory-game/audio/sfx_fail.mp3"></audio>
    <audio id="sfx-clear" src="https://y-sensei-lab.github.io/memory-game/audio/sfx_clear.mp3"></audio>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // ========== DOM要素の取得 ==========
    const titleScreen = document.getElementById('title-screen');
    const gameScreen = document.getElementById('game-screen');
    const clearModal = document.getElementById('clear-modal');
    
    const folderInput = document.getElementById('folder-input');
    const filesInput = document.getElementById('files-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imageInfo = document.getElementById('image-info');
    
    const difficultySelection = document.getElementById('difficulty-selection');
    const difficultyBtns = document.querySelectorAll('.difficulty-btn');
    
    const gameBoard = document.getElementById('game-board');
    const backToTitleBtn = document.getElementById('back-to-title-btn');
    const backToTitleFromClearBtn = document.getElementById('back-to-title-from-clear-btn');
    
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');

    // 音量関連
    const volumeSettingsBtn = document.getElementById('volume-settings-btn');
    const volumeControls = document.getElementById('volume-controls');
    const bgmVolumeSlider = document.getElementById('bgm-volume');
    const sfxVolumeSlider = document.getElementById('sfx-volume');
    
    // オーディオ要素
    const bgm = document.getElementById('bgm-main');
    const sfx = {
        button: document.getElementById('sfx-button'),
        open: document.getElementById('sfx-open'),
        pair: document.getElementById('sfx-pair'),
        fail: document.getElementById('sfx-fail'),
        clear: document.getElementById('sfx-clear'),
    };

    // ========== ゲームの状態管理 ==========
    let selectedImages = [];
    let difficulty = '';
    let firstCard = null;
    let secondCard = null;
    let lockBoard = false;
    let pairsFound = 0;
    let totalPairs = 0;
    let currentCardSize = 128; // initial card size in px (w-32)

    // ========== 音量管理 ==========
    const loadVolumeSettings = () => {
        const bgmVolume = localStorage.getItem('bgmVolume') || 0.5;
        const sfxVolume = localStorage.getItem('sfxVolume') || 0.5;
        bgmVolumeSlider.value = bgmVolume;
        sfxVolumeSlider.value = sfxVolume;
        applyVolumeSettings();
    };

    const applyVolumeSettings = () => {
        bgm.volume = bgmVolumeSlider.value * 0.25;
        Object.values(sfx).forEach(sound => sound.volume = sfxVolumeSlider.value);
    };

    const saveVolumeSettings = () => {
        localStorage.setItem('bgmVolume', bgmVolumeSlider.value);
        localStorage.setItem('sfxVolume', sfxVolumeSlider.value);
    };

    const playSfx = (sound) => {
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Audio play failed:", e));
    };

    // ========== 画面遷移 ==========
    const showScreen = (screen) => {
        titleScreen.classList.add('hidden');
        gameScreen.classList.add('hidden');
        if (screen === 'title') {
            titleScreen.classList.remove('hidden');
        } else if (screen === 'game') {
            gameScreen.classList.remove('hidden');
        }
    };
    
    // ========== 初期化処理 ==========
    const init = () => {
        showScreen('title');
        resetGameStates();
        loadVolumeSettings();
        // ユーザーのインタラクションを待ってBGMを再生
        document.body.addEventListener('click', () => {
             if (bgm.paused) {
                bgm.play().catch(e => console.log("BGM play failed:", e));
             }
        }, { once: true });
    };

    // ========== 画像選択処理 ==========
    const handleFileSelection = (files) => {
        selectedImages = [];
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
        
        imageInfo.classList.remove('hidden');

        if (imageFiles.length === 0) {
            imageInfo.textContent = '画像ファイルが見つかりませんでした。';
            return;
        }

        imageInfo.textContent = `${imageFiles.length}枚の画像を読み込み中...`;
        
        const readerPromises = imageFiles.map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsDataURL(file);
            });
        });

        Promise.all(readerPromises).then(results => {
            selectedImages = results;
            updateImagePreview();
            imageInfo.textContent = `${selectedImages.length}枚の画像を選択しました。`;
        }).catch(error => {
            console.error("画像読み込みエラー:", error);
            imageInfo.textContent = '画像の読み込みに失敗しました。';
        });
    };
    
    const updateImagePreview = () => {
        imagePreviewArea.innerHTML = '';
        if (selectedImages.length > 0) {
            imagePreviewArea.classList.remove('hidden');
            selectedImages.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'w-16 h-16 object-cover rounded-lg shadow-md';
                imagePreviewArea.appendChild(img);
            });
        } else {
            imagePreviewArea.classList.add('hidden');
        }
    };

    folderInput.addEventListener('change', (e) => {
        playSfx(sfx.button);
        filesInput.value = ''; // 同時選択を防ぐ
        handleFileSelection(e.target.files);
    });

    filesInput.addEventListener('change', (e) => {
        playSfx(sfx.button);
        folderInput.value = ''; // 同時選択を防ぐ
        handleFileSelection(e.target.files);
    });
    
    // ========== ゲーム開始処理 ==========
    difficultyBtns.forEach(button => {
        button.addEventListener('click', (e) => {
            if (selectedImages.length === 0) {
                imageInfo.classList.remove('hidden');
                imageInfo.textContent = '先に画像を選択してください！';
                return;
            }
            playSfx(sfx.button);
            difficulty = e.currentTarget.dataset.difficulty;
            startGame();
        });
    });

    const startGame = () => {
        // ゲーム開始時に必要なボードとスコアのリセットのみを実行
        gameBoard.innerHTML = '';
        resetTurn();
        pairsFound = 0;
        
        totalPairs = selectedImages.length;
        let gameImages = [...selectedImages, ...selectedImages]; // ペアを作成

        // Fisher-Yatesシャッフル
        for (let i = gameImages.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [gameImages[i], gameImages[j]] = [gameImages[j], gameImages[i]];
        }
        
        setupGameBoard(gameImages);
        showScreen('game');
    };
    
    const setupGameBoard = (images) => {
        // グリッドの列数を計算
        const numCards = images.length;
        const columns = Math.ceil(Math.sqrt(numCards));
        gameBoard.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        
        gameBoard.innerHTML = '';
        images.forEach((imageSrc, index) => {
            const card = document.createElement('div');
            card.style.width = `${currentCardSize}px`;
            card.style.height = `${currentCardSize}px`;
            card.dataset.id = imageSrc;
            card.classList.add('card', 'relative', 'cursor-pointer', 'rounded-xl', 'shadow-lg');
            
            card.innerHTML = `
                <div class="card-face card-front absolute w-full h-full rounded-xl bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center p-2">
                    <span class="font-pop text-4xl text-white drop-shadow-md">?</span>
                </div>
                <div class="card-face card-back absolute w-full h-full rounded-xl bg-white p-1">
                    <img src="${imageSrc}" class="w-full h-full object-cover rounded-lg" draggable="false">
                </div>
            `;
            
            if (difficulty === 'easy') {
                card.classList.add('is-flipped');
            }

            card.addEventListener('click', () => onCardClick(card));
            gameBoard.appendChild(card);
        });
    };

    // ========== ゲーム中のカードクリック処理 ==========
    const onCardClick = (card) => {
        if (lockBoard || card === firstCard || card.classList.contains('is-matched')) return;

        if (difficulty === 'hard') {
            // 既にめくられているカードを再度クリックして選択をキャンセルする場合
            if (card.classList.contains('is-flipped')) {
                card.classList.remove('is-flipped'); // 先にアニメーションを開始
                setTimeout(() => playSfx(sfx.open), 200); // 少し遅れて音を鳴らす
                firstCard = null;
                return;
            }
            // カードをめくる場合
            card.classList.add('is-flipped'); // 先にアニメーションを開始
            setTimeout(() => playSfx(sfx.open), 200); // 少し遅れて音を鳴らす

        } else { // easy mode
            playSfx(sfx.button);
            if (card.classList.contains('is-selected')) {
                 // 選択解除
                 card.classList.remove('is-selected', 'ring-4', 'ring-offset-2', 'ring-blue-500');
                 firstCard = null;
                 return;
            }
            card.classList.add('is-selected', 'ring-4', 'ring-offset-2', 'ring-blue-500');
        }

        if (!firstCard) {
            firstCard = card;
            return;
        }

        secondCard = card;
        lockBoard = true;
        checkForMatch();
    };

    const checkForMatch = () => {
        const isMatch = firstCard.dataset.id === secondCard.dataset.id;
        isMatch ? handleMatch() : handleMismatch();
    };

    const handleMatch = () => {
        const sfxDelay = difficulty === 'hard' ? 800 : 500;
        setTimeout(() => {
             playSfx(sfx.pair);
        }, sfxDelay);

        pairsFound++;
        
        firstCard.classList.add('is-matched');
        secondCard.classList.add('is-matched');
        
        setTimeout(() => {
            if (difficulty === 'easy') {
                firstCard.classList.remove('is-selected', 'ring-4', 'ring-offset-2', 'ring-blue-500');
                secondCard.classList.remove('is-selected', 'ring-4', 'ring-offset-2', 'ring-blue-500');
            }
            firstCard.style.visibility = 'hidden';
            secondCard.style.visibility = 'hidden';
            resetTurn();
            if (pairsFound === totalPairs) {
                endGame();
            }
        }, 1000);
    };

    const handleMismatch = () => {
        const sfxDelay = difficulty === 'hard' ? 800 : 500;
        setTimeout(() => {
            playSfx(sfx.fail);
        }, sfxDelay);

        setTimeout(() => {
            if (difficulty === 'hard') {
                firstCard.classList.remove('is-flipped');
                secondCard.classList.remove('is-flipped');
            } else { // easy mode
                firstCard.classList.remove('is-selected', 'ring-4', 'ring-offset-2', 'ring-blue-500');
                secondCard.classList.remove('is-selected', 'ring-4', 'ring-offset-2', 'ring-blue-500');
            }
            resetTurn();
        }, 1200);
    };

    const resetTurn = () => {
        [firstCard, secondCard] = [null, null];
        lockBoard = false;
    };
    
    const resetGameStates = () => {
        gameBoard.innerHTML = '';
        selectedImages = [];
        difficulty = '';
        resetTurn();
        pairsFound = 0;
        totalPairs = 0;
        imagePreviewArea.innerHTML = '';
        imagePreviewArea.classList.add('hidden');
        imageInfo.textContent = '';
        imageInfo.classList.add('hidden');
        folderInput.value = '';
        filesInput.value = '';
    };

    const endGame = () => {
        playSfx(sfx.clear);
        setTimeout(() => {
            const modalContent = clearModal.querySelector('div');
            if (clearModal) clearModal.classList.remove('hidden');
            if(modalContent){
                setTimeout(() => {
                    modalContent.classList.remove('scale-75', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 50);
            }
        }, 500);
    };

    // ========== イベントリスナー設定 ==========
    backToTitleBtn.addEventListener('click', () => {
        playSfx(sfx.button);
        init();
    });

    backToTitleFromClearBtn.addEventListener('click', () => {
        playSfx(sfx.button);
        const modalContent = clearModal.querySelector('div');
        if (modalContent) {
            modalContent.classList.add('scale-75', 'opacity-0');
        }
        setTimeout(() => {
            if (clearModal) clearModal.classList.add('hidden');
            init();
        }, 300);
    });

    volumeSettingsBtn.addEventListener('click', () => {
        playSfx(sfx.button);
        if (volumeControls) {
            volumeControls.classList.toggle('hidden');
        }
    });

    bgmVolumeSlider.addEventListener('input', () => {
        applyVolumeSettings();
        saveVolumeSettings();
    });

    sfxVolumeSlider.addEventListener('input', () => {
        applyVolumeSettings();
        playSfx(sfx.button); // 設定変更がわかるように音を鳴らす
        saveVolumeSettings();
    });
    
    // 音量調整の外側をクリックしたら閉じる
    document.addEventListener('click', (event) => {
        if (volumeControls && volumeSettingsBtn) {
             if (!volumeControls.classList.contains('hidden') && 
                !volumeControls.contains(event.target) && 
                !volumeSettingsBtn.contains(event.target)) {
                volumeControls.classList.add('hidden');
            }
        }
    });

    const adjustCardSize = (delta) => {
        playSfx(sfx.button);
        const newSize = currentCardSize + delta;
        if (newSize >= 48 && newSize <= 256) { // 最小・最大サイズ制限
            currentCardSize = newSize;
            const cards = gameBoard.querySelectorAll('.card');
            cards.forEach(card => {
                card.style.width = `${currentCardSize}px`;
                card.style.height = `${currentCardSize}px`;
            });
        }
    };

    zoomInBtn.addEventListener('click', () => adjustCardSize(16));
    zoomOutBtn.addEventListener('click', () => adjustCardSize(-16));


    // ========== アプリケーション開始 ==========
    init();
});
</script>

</body>
</html>